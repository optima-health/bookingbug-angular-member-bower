(function(){'use strict';angular.module("BBMember",["BB","BBMember.Directives","BBMember.Services","BBMember.Filters","BBMember.Controllers","BBMember.Models","trNgGrid","pascalprecht.translate"]),angular.module("BBMember.Directives",[]),angular.module("BBMember.Filters",[]),angular.module("BBMember.Models",[]),angular.module("BBMember.Services",["ngResource","ngSanitize"]),angular.module("BBMember.Controllers",["ngSanitize"]),angular.module("BBMemberMockE2E",["BBMember","BBAdminMockE2E"])}).call(this),function(){'use strict';angular.module("BBMember").config(["$logProvider",function(e){'ngInject';e.debugEnabled(!0)}])}.call(this),function(){'use strict';angular.module("BBMember").run(["$q","$injector","BBModel",function(e,t,o){'ngInject';var r,a,l,n,m;for(TrNgGrid.defaultColumnOptions.enableFiltering=!1,m=["Member","Booking","Wallet","WalletLog","Purchase","PurchaseItem","WalletPurchaseBand","PaymentItem"],l={},(r=0,a=m.length);r<a;r++)n=m[r],l[n]=t.get("Member."+n+"Model");o.Member=l}])}.call(this),function(){angular.module("BBMember").directive("bbMemberBooking",function(){return{templateUrl:"_member_booking.html",scope:{booking:"=bbMemberBooking"},require:["^?bbMemberUpcomingBookings","^?bbMemberPastBookings"],link:function(e,t,o,r){var a,l;if(e.actions=[],a=r[0]?r[0]:r[1],l=moment(),e.booking.on_waitlist&&!e.booking.datetime.isBefore(l,"day")&&e.actions.push({action:a.book,label:"Book",translation_key:"MEMBER_BOOKING_WAITLIST_ACCEPT",disabled:!e.booking.settings.sent_waitlist}),e.booking.paid<e.booking.price&&e.booking.datetime.isAfter(l)&&e.actions.push({action:a.pay,label:"Pay"}),e.actions.push({action:a.edit,label:"Details",translation_key:"MEMBER_BOOKING_EDIT"}),!e.booking.datetime.isBefore(l,"day"))return e.actions.push({action:a.cancel,label:"Cancel",translation_key:"MEMBER_BOOKING_CANCEL"})}}})}.call(this),function(){angular.module("BBMember").directive("memberBookings",["$rootScope",function(){return{templateUrl:"member_bookings_tabs.html",scope:{member:"="},link:function(){}}}])}.call(this),function(){angular.module("BBMember").directive("memberBookingsTable",["$uibModal","$log","ModalForm","BBModel",function(e,t,o,r){var a;return a=function(e,a){var l;if(e.loading=!0,e.fields||(e.fields=["date_order","details"]),e.$watch("member",function(t){if(null!=t)return l(e,t)}),e.edit=function(t){var a;return a=_.find(e.booking_models,function(e){return e.id===t}),a.$getAnswers().then(function(l){var n,m,i,s;for(s=l.answers,m=0,i=s.length;m<i;m++)n=s[m],a["question"+n.question_id]=n.value;return o.edit({model:a,title:"Booking Details",templateUrl:"edit_booking_modal_form.html",success:function(o){var a;return o=new r.Member.Booking(o),a=_.indexOf(e.booking_models,function(e){return e.id===t}),e.booking_models[a]=o,e.setRows()}})})},e.cancel=function(t){var o,r;return o=_.find(e.booking_models,function(e){return e.id===t}),r=a.open({templateUrl:"member_bookings_table_cancel_booking.html",controller:["$scope","$uibModalInstance","booking",function(e,t,o){return e.booking=o,e.booking.notify=!0,e.ok=function(){return t.close(e.booking)},e.close=function(){return t.dismiss()}}],scope:e,resolve:{booking:function(){return o}}}),r.result.then(function(t){var o;return e.loading=!0,o={notify:t.notify},t.$post("cancel",o).then(function(){var o;return o=_.findIndex(e.booking_models,function(e){return e.id===t.id}),e.booking_models.splice(o,1),e.setRows(),e.loading=!1})})},e.setRows=function(){return e.bookings=_.map(e.booking_models,function(e){return{id:e.id,date:moment(e.datetime).format("YYYY-MM-DD"),date_order:moment(e.datetime).format("x"),datetime:moment(e.datetime),details:e.full_describe}})},l=function(e,o){var a;return a={src:o,start_date:e.startDate.format("YYYY-MM-DD"),start_time:e.startTime?e.startTime.format("HH:mm"):void 0,end_date:e.endDate?e.endDate.format("YYYY-MM-DD"):void 0,end_time:e.endTime?e.endTime.format("HH:mm"):void 0},r.Member.Booking.$query(o,a).then(function(t){var o;return o=moment.unix(),e.period&&"past"===e.period&&(e.booking_models=_.filter(t.items,function(e){return e.datetime.unix()<o})),e.booking_models=e.period&&"future"===e.period?_.filter(t.items,function(e){return e.datetime.unix()>o}):t.items,e.setRows(),e.loading=!1},function(o){return t.error(o.data),e.loading=!1})},e.startDate||(e.startDate=moment()),e.orderBy=e.defaultOrder,null==e.orderBy&&(e.orderBy="date_order"),e.now=moment(),e.member)return l(e,e.member)},{controller:a,templateUrl:"member_bookings_table.html",scope:{apiUrl:"@",fields:"=?",member:"=",startDate:"=?",startTime:"=?",endDate:"=?",endTime:"=?",defaultOrder:"=?",period:"=?"}}}])}.call(this),function(){angular.module("BBMember").directive("memberForm",["$rootScope","AlertService","PathSvc",function(e,t,o){return{templateUrl:function(e,t){return null==t.bbCustomMemberForm?o.directivePartial("_member_schema_form"):o.directivePartial("_member_form")},scope:{apiUrl:"@",member:"=",onSuccessSave:"=",onFailSave:"=",onValidationError:"="},link:function(t,o,r){var a,l;if(e.bb||(e.bb={}),(a=e.bb).api_url||(a.api_url=r.apiUrl),(l=e.bb).api_url||(l.api_url="http://www.bookingbug.com"),null!=r.bbCustomMemberForm)return t.custom_member_form=!0},controller:["$scope","FormTransform",function(e,o){var r,a;return e.loading=!0,r=function(e){var t,o,r,a,l,n,m,i,s,c;for(l in i=e.properties,i)s=i[l],c=l.split("."),"questions"===c[0]&&1<c.length&&((t=e.properties).questions||(t.questions={type:"object",properties:{}}),(o=e.properties.questions.properties)[n=c[1]]||(o[n]={type:"object",properties:{answer:s}})),"client"===c[0]&&2<c.length&&((r=e.properties).client||(r.client={type:"object",properties:{q:{type:"object",properties:{}}}}),e.properties.client.properties&&((a=e.properties.client.properties.q.properties)[m=c[2]]||(a[m]={type:"object",properties:{answer:s}})));return e},e.$watch("member",function(t){if(null!=t){if(t.$has("edit_member"))return t.$get("edit_member").then(function(l){var n;return e.form=l.form,n=a(t.constructor),o.edit[n]&&(e.form=o.edit[n](e.form,l.schema,t)),e.schema=r(l.schema),e.loading=!1});if(t.$has("edit"))return t.$get("edit").then(function(l){var n;return e.form=l.form,n=a(t.constructor),o.edit[n]&&(e.form=o.edit[n](e.form,l.schema,t)),e.schema=r(l.schema),e.loading=!1})}}),a=function(e){var t;return t=/^function\s+([\w\$]+)\s*\(/.exec(e.toString()),t?t[1]:""},e.submit=function(o,r){var a,l,n,m;if(e.$broadcast("schemaFormValidate"),o.$valid){if(e.loading=!0,!e.custom_member_form)for(m=r.questions,a=0,n=m.length;a<n;a++)l=m[a],l.answer=r.q[l.id].answer;return e.member.$put("self",{},r).then(function(){if(e.loading=!1,t.raise("UPDATE_SUCCESS"),"function"==typeof e.onSuccessSave)return e.onSuccessSave()},function(){if(e.loading=!1,t.raise("UPDATE_FAILED"),"function"==typeof e.onFailSave)return e.onFailSave()})}return"function"==typeof e.onValidationError?e.onValidationError():void 0}}]}}])}.call(this),function(){angular.module("BBMember").directive("loginMember",["$uibModal","$document","$log","$rootScope","MemberLoginService","$templateCache","$q","$sessionStorage","halClient",function(e,t,o,r,a,l,n,m,i){var s,c,d;return c=function(e,t,o){return e.title="Login",e.schema={type:"object",properties:{email:{type:"string",title:"Email"},password:{type:"string",title:"Password"}}},e.form=[{key:"email",type:"email",feedback:!1,autofocus:!0},{key:"password",type:"password",feedback:!1}],e.login_form={},e.submit=function(e){var r;return r={company_id:o},a.login(e,r).then(function(o){return o.email=e.email,o.password=e.password,t.close(o)},function(e){return t.dismiss(e)})},e.cancel=function(){return t.dismiss("cancel")}},d=function(e,t,o){var r;return e.title="Pick Company",e.schema={type:"object",properties:{company_id:{type:"integer",title:"Company"}}},e.schema.properties.company_id["enum"]=function(){var e,t,a;for(a=[],e=0,t=o.length;e<t;e++)r=o[e],a.push(r.id);return a}(),e.form=[{key:"company_id",type:"select",titleMap:function(){var e,t,a;for(a=[],e=0,t=o.length;e<t;e++)r=o[e],a.push({value:r.id,name:r.name});return a}(),autofocus:!0}],e.pick_company_form={},e.submit=function(e){return t.close(e.company_id)},e.cancel=function(){return t.dismiss("cancel")}},s=function(t){var o,l,s,p,b,u;return r.bb||(r.bb={}),(o=r.bb).api_url||(o.api_url=t.apiUrl),(l=r.bb).api_url||(l.api_url="http://www.bookingbug.com"),s=function(){var o;return o=e.open({templateUrl:"login_modal_form.html",controller:c,resolve:{company_id:function(){return t.companyId}}}),o.result.then(function(e){return t.memberEmail=e.email,t.memberPassword=e.password,e.$has("members")?e.$get("members").then(function(e){var o;return t.members=e,n.all(function(){var t,r,a;for(a=[],t=0,r=e.length;t<r;t++)o=e[t],a.push(o.$get("company"));return a}()).then(function(e){return p(e)})}):t.member=e},function(){return s()})},p=function(o){var r;return r=e.open({templateUrl:"pick_company_modal_form.html",controller:d,resolve:{companies:function(){return o}}}),r.result.then(function(e){return t.companyId=e,u()},function(){return p()})},u=function(){var e,o;return e={email:t.memberEmail,password:t.memberPassword},o={company_id:t.companyId},a.login(e,o).then(function(e){return e.$has("members")?e.$get("members").then(function(e){var o;return t.members=e,n.all(function(){var t,r,a;for(a=[],t=0,r=e.length;t<r;t++)o=e[t],a.push(o.$get("company"));return a}()).then(function(e){return p(e)})}):t.member=e},function(){return s()})},t.memberEmail&&t.memberPassword?u():m.getItem("login")?(b=m.getItem("login"),b=i.createResource(b),t.member=b):s()},{link:s,scope:{memberEmail:"@",memberPassword:"@",companyId:"@",apiUrl:"@",member:"="},transclude:!0,template:"<div ng-show='member' ng-transclude></div>"}}])}.call(this),function(){angular.module("BBMember").directive("bbMemberPastBookings",["$rootScope","PaginationService",function(e,t){return{templateUrl:"member_past_bookings.html",scope:{member:"=",notLoaded:"=",setLoaded:"="},controller:"MemberBookings",link:function(e){var o;if(e.pagination=t.initialise({page_size:10,max_size:5}),o=function(){return e.getPastBookings().then(function(o){if(o)return t.update(e.pagination,o.length)})},e.$watch("member",function(){if(e.member&&!e.past_bookings)return o()}),e.member)return o()}}}])}.call(this),function(){angular.module("BBMember").directive("bbMemberPrePaidBookings",["$rootScope","PaginationService",function(e,t){return{templateUrl:"member_pre_paid_bookings.html",scope:{member:"="},controller:"MemberBookings",link:function(e){var o;if(e.pagination=t.initialise({page_size:10,max_size:5}),o=function(){return e.getPrePaidBookings({}).then(function(o){return t.update(e.pagination,o.length)})},e.$watch("member",function(){if(!e.pre_paid_bookings)return o()}),e.$on("booking:cancelled",function(){return e.getPrePaidBookings({}).then(function(o){return t.update(e.pagination,o.length)})}),e.member)return o()}}}])}.call(this),function(){angular.module("BBMember").directive("bbMemberPurchases",["$rootScope","PaginationService",function(e,t){return{templateUrl:"member_purchases.html",scope:!0,controller:"MemberPurchases",link:function(o,r,a){return o.member=o.$eval(a.member),e.member&&(o.member||(o.member=e.member)),o.pagination=t.initialise({page_size:10,max_size:5}),e.connection_started.then(function(){if(o.member)return o.getPurchases().then(function(e){return t.update(o.pagination,e.length)})})}}}])}.call(this),function(){angular.module("BBMember").directive("memberSsoLogin",["$rootScope","LoginService","$sniffer","$timeout","QueryStringService",function(e,t,o,r,a){return{scope:{token:"@memberSsoLogin",company_id:"@companyId"},transclude:!0,template:"<div ng-if='member' ng-transclude></div>",link:function(l){var n,m;return m={root:e.bb.api_url,company_id:l.company_id},n={},l.token&&(n.token=l.token),n.token||(n.token=a("sso_token")),o.msie&&10>o.msie&&!1===e.iframe_proxy_ready?r(function(){return t.ssoLogin(m,n).then(function(e){return l.member=e})},2e3):t.ssoLogin(m,n).then(function(e){return l.member=e})}}}])}.call(this),function(){angular.module("BBMember").directive("bbMemberUpcomingBookings",["$rootScope","PaginationService","PurchaseService",function(e,t){return{templateUrl:"member_upcoming_bookings.html",scope:{member:"=",notLoaded:"=",setLoaded:"="},controller:"MemberBookings",link:function(o){var r;return o.pagination=t.initialise({page_size:10,max_size:5}),r=function(){return o.getUpcomingBookings().then(function(e){return t.update(o.pagination,e.length)})},o.$on("updateBookings",function(){return o.flushBookings(),r()}),o.$watch("member",function(){if(!o.upcoming_bookings)return r()}),e.connection_started.then(function(){return r()})}}}])}.call(this),function(){angular.module("BBMember").directive("bbWallet",["$rootScope",function(e){return{scope:!0,controller:"Wallet",templateUrl:"wallet.html",link:function(t,o,r){return t.member=t.$eval(r.member),e.member&&(t.member||(t.member=e.member)),t.show_wallet_logs=!0,t.show_topup_box=!1,e.connection_started.then(function(){if(t.member)return t.getWalletForMember(t.member)}),t.$on("wallet:topped_up",function(e,o){return t.wallet=o,t.show_topup_box=!1,t.show_wallet_logs=!0}),t.$on("booking:cancelled",function(){if(t.member)return t.getWalletForMember(t.member)})}}}])}.call(this),function(){angular.module("BBMember").directive("bbWalletLogs",["$rootScope","PaginationService",function(e,t){return{templateUrl:"wallet_logs.html",scope:!0,controller:"Wallet",require:"^?bbWallet",link:function(o,r,a,l){var n;return o.member=o.$eval(a.member),e.member&&(o.member||(o.member=e.member)),o.pagination=t.initialise({page_size:10,max_size:5}),n=function(){return o.getWalletLogs().then(function(e){return t.update(o.pagination,e.length)})},o.$on("wallet:topped_up",function(){return n()}),e.connection_started.then(function(){var e;return l?e=o.$watch("wallet",function(){if(o.wallet)return n(),e()}):o.getWalletForMember(o.member).then(function(){return n()})})}}}])}.call(this),function(){angular.module("BB.Directives").directive("bbWalletPayment",["$sce","$rootScope","$window","$location","GeneralOptions","AlertService",function(e,t,o,r,a,l){return{restrict:"A",controller:"Wallet",scope:!0,replace:!0,require:"^?bbWallet",link:function(n,m,i,s){var c,d,p,b;return p=100,n.wallet_payment_options=n.$eval(i.bbWalletPayment)||{},n.member=n.$eval(i.member),t.member&&(n.member||(n.member=t.member)),n.wallet_payment_options.member&&(n.member||(n.member=n.wallet_payment_options.member)),n.amount_increment=n.wallet_payment_options.amount_increment||p,d=function(e){var t;return t=document.createElement("a"),t.href=e,t.protocol+"//"+t.host},b=function(e,t,o){var l,n,m,i;return i=r.protocol()+"://"+r.host(),r.port()&&(i+=":"+r.port()),n=o.wallet_payment_options.custom_stylesheet?o.wallet_payment_options.custom_stylesheet:null,l=o.bb&&o.bb.custom_partial_url?o.bb.custom_partial_url:null,m=JSON.stringify({type:"load",message:i,custom_partial_url:l,custom_stylesheet:n,scroll_offset:a.scroll_offset}),e.find("iframe")[0].contentWindow.postMessage(m,t)},c=function(){var t,e=Math.ceil;return n.wallet_payment_options.basket_topup?(t=n.bb.basket.dueTotal()-n.wallet.amount,n.amount=t>n.wallet.min_amount?e(t/n.amount_increment)*n.amount_increment:n.wallet.min_amount,n.min_amount=n.amount):n.wallet.min_amount?(n.amount=n.wallet_payment_options.amount&&n.wallet_payment_options.amount>n.wallet.min_amount?n.wallet_payment_options.amount:n.wallet.min_amount,n.min_amount=n.wallet.min_amount):(n.min_amount=0,n.wallet_payment_options.amount)?n.amount=n.wallet_payment_options.amount:void 0},t.connection_started.then(function(){var e;return s?e=n.$watch("wallet",function(){if(n.wallet)return c(),e()}):n.getWalletForMember(n.member).then(function(){return c()})}),n.$on("wallet:updated",function(t,o,r){if(null==r&&(r=null),o.$has("new_payment"))return n.notLoaded(n),r&&(n.amount=r.actual_amount),n.wallet_payment_url=e.trustAsResourceUrl(o.$href("new_payment")),n.show_payment_iframe=!0,m.find("iframe").bind("load",function(){return function(){var e,t;return n.wallet_payment_url&&(t=n.wallet_payment_url),e=d(t),b(m,e,n),n.$apply(function(){return n.setLoaded(n)})}}(this))}),o.addEventListener("message",function(){return function(e){var o;return angular.isObject(e.data)?o=e.data:!e.data.match(/iFrameSizer/)&&(o=JSON.parse(e.data)),n.$apply(function(){if(o)switch(o.type){case"submitting":return n.notLoaded(n);case"error":return t.$broadcast("wallet:topup_failed"),n.notLoaded(n),document.getElementsByTagName("iframe")[0].src+="",l.raise("PAYMENT_FAILED");case"payment_complete":case"wallet_payment_complete":case"basket_wallet_payment_complete":return n.show_payment_iframe=!1,n.wallet_payment_options.basket_topup?n.basketWalletPaymentDone():n.walletPaymentDone();}})}}(this),!1)}}}])}.call(this),function(){angular.module("BB.Directives").directive("bbWalletPurchaseBands",["$rootScope",function(e){return{scope:!0,restrict:"AE",templateUrl:"wallet_purchase_bands.html",controller:"Wallet",require:"^?bbWallet",link:function(t,o,r,a){return t.member=t.$eval(o.member),e.member&&(t.member||(t.member=e.member)),e.connection_started.then(function(){var e;return a?e=t.$watch("wallet",function(){if(t.wallet)return t.getWalletPurchaseBandsForWallet(t.wallet),e()}):t.getWalletForMember(t.member).then(function(){return t.getWalletPurchaseBandsForWallet(t.wallet)})})}}}])}.call(this),function(){'use strict';angular.module("BBMember").controller("MemberBookings",["$scope","$uibModal","$document","$log","$q","ModalForm","$rootScope","AlertService","PurchaseService","LoadingService","BBModel",function(e,t,o,r,a,l,n,m,i,s,c){var d,p,b,u,g;return b=s.$loader(e),e.getUpcomingBookings=function(){var t,o,r;return t=a.defer(),o=moment(),r={start_date:o.toISODate()},p(r).then(function(r){return e.upcoming_bookings=_.filter(r,function(e){return e.datetime.isAfter(o)}),t.resolve(e.upcoming_bookings)},function(){return t.reject([])}),t.promise},e.getPastBookings=function(t,o){var r,l,n;return l=a.defer(),r=t&&o?moment().subtract(t,o):moment().subtract(1,"year"),n={start_date:r.format("YYYY-MM-DD"),end_date:moment().add(1,"day").format("YYYY-MM-DD")},p(n).then(function(t){return e.past_bookings=_.chain(t).filter(function(e){return e.datetime.isBefore(moment())}).sortBy(function(e){return-e.datetime.unix()}).value(),l.resolve(t)},function(){return l.reject([])}),l.promise},e.flushBookings=function(){var t;return t={start_date:moment().format("YYYY-MM-DD")},e.member.$flush("bookings",t)},g=function(){return e.getUpcomingBookings()},p=function(t){var o;return b.notLoaded(),o=a.defer(),e.member.getBookings(t).then(function(e){return b.setLoaded(),o.resolve(e)},function(e){return r.error(e.data),b.setLoaded()}),o.promise},e.cancelBooking=function(t){var o;return o=_.indexOf(e.upcoming_bookings,t),_.without(e.upcoming_bookings,t),c.Member.Booking.$cancel(e.member,t).then(function(){if(m.raise("BOOKING_CANCELLED"),n.$broadcast("booking:cancelled"),e.removeBooking)return e.removeBooking(t)},function(){return m.raise("GENERIC"),e.upcoming_bookings.splice(o,0,t)})},e.getPrePaidBookings=function(t){var o;return o=a.defer(),e.member.$getPrePaidBookings(t).then(function(t){return e.pre_paid_bookings=t,o.resolve(t)},function(e){return o.reject([]),r.error(e.data)}),o.promise},d=function(){return m.raise("WAITLIST_ACCEPTED"),g()},u=function(e,o){var r;return r=t.open({templateUrl:"booking_payment_modal.html",windowClass:"bbug",size:"lg",controller:["$scope","$uibModalInstance","booking","total",function(e,t,o,r){return e.booking=o,e.total=r,e.handlePaymentSuccess=function(){return t.close(o)},e.cancel=function(){return t.dismiss("cancel")}}],resolve:{booking:function(){return e},total:function(){return o}}}),r.result.then(function(){return d()})},{edit:function(e){return e.$getAnswers().then(function(t){var o,r,a,n;for(n=t.answers,r=0,a=n.length;r<a;r++)o=n[r],e["question"+o.question_id]=o.value;return l.edit({model:e,title:"Booking Details",templateUrl:"edit_booking_modal_form.html",windowClass:"member_edit_booking_form",success:g})})},cancel:function(o){var r;return r=t.open({templateUrl:"member_booking_delete_modal.html",windowClass:"bbug",controller:["$scope","$rootScope","$uibModalInstance","booking",function(e,t,o,r){return e.booking=r,e.confirm_delete=function(){return o.close(r)},e.cancel=function(){return o.dismiss("cancel")}}],resolve:{booking:function(){return o}}}),r.result.then(function(t){return e.cancelBooking(t)})},book:function(e){var t;return b.notLoaded(),t={purchase_id:e.purchase_ref,url_root:n.bb.api_url,booking:e},i.bookWaitlistItem(t).then(function(t){return 0<t.due_now?t.$has("new_payment")?u(e,t):r.error("total is missing new_payment link, this is usually caused by online payment not being configured correctly"):d()},function(){return m.raise("NO_WAITLIST_SPACES_LEFT")}),b.setLoaded()},pay:function(t){var o;return o={url_root:e.$root.bb.api_url,purchase_id:t.purchase_ref},i.query(o).then(function(e){return u(t,e)})}}}])}.call(this),function(){angular.module("BBMember").controller("MemberPurchases",["$scope","$q","$log","LoadingService","BBModel",function(e,t,o,r,a){return e.getPurchases=function(){var l,n;return n=r.$loader(e).notLoaded(),l=t.defer(),a.Member.Purchase.$query(e.member,{}).then(function(t){return e.purchases=t,n.setLoaded(),l.resolve(t)},function(e){return o.error(e.data),n.setLoaded(),l.reject([])}),l.promise}}])}.call(this),function(){angular.module("BBMember").controller("Wallet",["$scope","$rootScope","$q","$log","AlertService","LoadingService","BBModel",function(e,t,o,r,a,l,n){var m,i;return m=l.$loader(e),e.getWalletForMember=function(t,r){var a;return a=o.defer(),m.notLoaded(),n.Member.Wallet.$getWalletForMember(t,r).then(function(t){return m.setLoaded(),e.wallet=t,i(t),a.resolve(t)},function(){return m.setLoaded(),a.reject()}),a.promise},e.getWalletLogs=function(){var t;return t=o.defer(),m.notLoaded(),n.Member.Wallet.$getWalletLogs(e.wallet).then(function(o){return o=_.sortBy(o,function(e){return-moment(e.created_at).unix()}),m.setLoaded(),e.logs=o,t.resolve(o)},function(e){return m.setLoaded(),r.error(e.data),t.reject([])}),t.promise},e.getWalletPurchaseBandsForWallet=function(t){var a;return a=o.defer(),m.notLoaded(),n.Member.Wallet.$getWalletPurchaseBandsForWallet(t).then(function(t){return e.bands=t,m.setLoaded(),a.resolve(t)},function(e){return m.setLoaded(),r.error(e.data),a.resolve([])}),a.promise},e.createWalletForMember=function(t){return m.notLoaded(),n.Member.Wallet.$createWalletForMember(t).then(function(t){return m.setLoaded(),e.wallet=t},function(e){return m.setLoaded(),r.error(e.data)})},e.updateWallet=function(o,a,l){var i;if(null==l&&(l=null),m.notLoaded(),o)return i={},0<a&&(i.amount=a),e.wallet&&(i.wallet_id=e.wallet.id),e.total&&(i.total_id=e.total.id),e.deposit&&(i.deposit=e.deposit),e.basket&&(i.basket_total_price=e.basket.total_price),l&&(i.band_id=l.id),n.Member.Wallet.$updateWalletForMember(o,i).then(function(o){return m.setLoaded(),e.wallet=o,t.$broadcast("wallet:updated",o,l)},function(e){return m.setLoaded(),r.error(e.data)})},e.activateWallet=function(t){var o;if(m.notLoaded(),t)return o={status:1},e.wallet&&(o.wallet_id=e.wallet.id),n.Member.Wallet.$updateWalletForMember(t,o).then(function(t){return m.setLoaded(),e.wallet=t},function(e){return m.setLoaded(),r.error(e.date)})},e.deactivateWallet=function(t){var o;if(m.notLoaded(),t)return o={status:0},e.wallet&&(o.wallet_id=e.wallet.id),n.Member.Wallet.$updateWalletForMember(t,o).then(function(t){return m.setLoaded(),e.wallet=t},function(e){return m.setLoaded(),r.error(e.date)})},e.purchaseBand=function(t){return e.selected_band=t,e.updateWallet(e.member,t.wallet_amount,t)},e.walletPaymentDone=function(){return e.getWalletForMember(e.member).then(function(o){return a.raise("TOPUP_SUCCESS"),t.$broadcast("wallet:topped_up",o),e.wallet_topped_up=!0})},e.basketWalletPaymentDone=function(){return e.callSetLoaded(),e.decideNextPage("checkout")},e.error=function(){return a.warning("TOPUP_FAILED")},e.add=function(t){return t=t||e.amount_increment,e.amount+=t},e.subtract=function(t){return t=t||e.amount_increment,e.add(-t)},e.isSubtractValid=function(t){var o;return!!e.wallet&&(t=t||e.amount_increment,o=e.amount-t,o>=e.wallet.min_amount)},i=function(t){if(e.member.self===e.client.self)return e.client.wallet_amount=t.amount}}])}.call(this),function(){"use strict";angular.module("BBMember").config(["$translateProvider",function(e){"ngInject";var t;t={MEMBER:{MODAL:{EDIT_BOOKING:{CANCEL_BTN:"@:COMMON.BTN.CANCEL",SAVE_BTN:"@:COMMON.BTN.SAVE"},LOGIN:{OK_BTN:"@:COMMON.BTN.OK",CANCEL_BTN:"@:COMMON.BTN.CANCEL"},DELETE_BOOKING:{TITLE:"@:COMMON.BTN.CANCEL_BOOKING",DESCRIPTION_LBL:"@:COMMON.TERMINOLOGY.BOOKING",WHEN_LBL:"@:COMMON.TERMINOLOGY.WHEN",CANCEL_BOOKING_BTN:"@:COMMON.BTN.CANCEL_BOOKING",CANCEL_BTN:"@:COMMON.BTN.DO_NOT_CANCEL_BOOKING"},BOOKINGS_TABLE_CANCEL_BOOKING:{TITLE:"@:COMMON.BTN.CANCEL_BOOKING",EMAIL_CUSTOMER_CHECKBOX_LBL:"Email customer?",CANCEL_BOOKING_BTN:"@:COMMON.BTN.CANCEL_BOOKING",CANCEL_BTN:"@:COMMON.BTN.DO_NOT_CANCEL_BOOKING"},PICK_COMPANY:{OK_BTN:"@:COMMON.BTN.OK",CANCEL_BTN:"@:COMMON.BTN.CANCEL"},BOOKING_PAYMENT:{DESCRIPTION:"Pay for your booking to confirm your place.",TIME_RANGE:"{{start}} - {{end}}",PAY_BTN:"@:COMMON.BTN.PAY"}},LOGIN:{EMAIL_LBL:"@:COMMON.TERMINOLOGY.EMAIL",EMAIL_PLACEHOLDER:"@:COMMON.TERMINOLOGY.EMAIL",PASSWORD_LBL:"@:COMMON.FORM.PASSWORD",PASSWORD_PLACEHOLDER:"@:COMMON.FORM.PASSWORD",LOGIN_BTN:"@:COMMON.BTN.LOGIN"},MEMBER_BOOKINGS_TABLE:{DETAILS_BTN:"@:COMMON.BTN.DETAILS",CANCEL_BTN:"@:COMMON.BTN.CANCEL"},BOOKING:{TOGGLE_DROPDOWN_BTN:"Toggle Dropdown"},BOOKING_TABS:{UPCOMING_BOOKINGS_TAB_HEADING:"Upcoming bookings",PAST_BOOKINGS_TAB_HEADING:"Past bookings",PURCHASES_TAB_HEADING:"Purchases"},MEMBER_PAST_BOOKINGS:{NO_PAST_BOOKINGS:"You don't currently have any past bookings."},PAST_BOOKINGS:{HEADING:"Past Bookings"},PREPAID_BOOKINGS:{NO_PREPAID_BOOKINGS:"You don't currently have any pre-paid bookings.",REMAINING_BOOKINGS:"{{remaining}} of {{total}} remaining",PREPAID_BOOKING_DATES:"Book By {{book_by}} | Use from {{use_from}} | Use by {{use_by}}"},PURCHASES:{YOUR_PURCHASES:"Your Purchases",NO_CURRENT_PURCHASES:"You don't currently have any purchases",PURCHASE_DATE_COL_HEADING:"Purchase Date",ITEMS_COL_HEADING:"Items",TOTAL_PRICE_COL_HEADING:"Total Price",LESS_DETAIL_BTN:"@:COMMON.BTN.LESS",MORE_DETAIL_BTN:"@:COMMON.BTN.MORE"},MEMBER_UPCOMING_BOOKINGS:{NO_UPCOMING_BOOKINGS:"You don't currently have any upcoming bookings.",ON_WAITLIST_HEADING:"On Waitlist",CONFIRMED_HEADING:"Confirmed"},UPCOMING_BOOKINGS:{HEADING:"Upcoming Bookings"},PICK_COMPANY:{DESCRIPTION:"Pick Company"},WAITLIST_PAYMENT:{DESCRIPTION:"Pay for your booking to confirm your place.",PAY_BTN:"@:COMMON.BTN.PAY"},WALLET:{BALANCE_LBL:"Balance:",WALLET_NO_CREDIT:"You don't have any credit in your wallet.",STATUS_LBL:"Status:",STATUS_INACTIVE:"Your wallet is not active.",STATUS_ACTIVE:"Active",ACTIVATE_BTN:"Activate",TOP_UP_BTN:"@:COMMON.BTN.TOP_UP",AMOUNT_LBL:"Amount",PAYMENT_IFRAME_HEADING:"Make Payment",TOP_UP_WALLET_BY:"Top up wallet by {{amount | currency}}",MIN_TOP_UP:"Minimum top up amount must be greater than {{min_amount | currency}}",TOPUP_AMOUNT_PLACEHOLDER:"Enter Top Up Amount"},WALLET_LOGS:{HEADING:"Wallet Transaction History",ACTION_COL_HEADING:"Action",AMOUNT_COL_HEADING:"Amount",BALANCE_COL_HEADING:"Balance",CHANGED_BY_COL_HEADING:"Changed By",DATE_TIME_COL_HEADING:"@:COMMON.TERMINOLOGY.DATE_TIME"},WALLET_PURCHASE_BANDS:{HEADING:"Wallet Purchase Bands",$X_FOR_$Y:"{{x | currency}} for {{y | currency}}",BUY_BTN:"@:COMMON.BTN.BUY"},PURCHASE_HISTORY:{HEADING:"Purchase History"}}},e.translations("en",t)}])}.call(this),function(){angular.module("BBMember.Services").factory("MemberBookingService",["$q","SpaceCollections","$rootScope","MemberService","BBModel",function(e,t,o,r,a){return{query:function(t,o){var r;return r=e.defer(),o||(o={}),o.no_cache=!0,t.$has("bookings")?t.$get("bookings",o).then(function(){return function(e){var t;return angular.isArray(e)?(e=function(){var o,r,l;for(l=[],o=0,r=e.length;o<r;o++)t=e[o],l.push(new a.Member.Booking(t));return l}(),r.resolve(e)):(o.no_cache=!1,e.$get("bookings",o).then(function(e){return e=function(){var o,r,l;for(l=[],o=0,r=e.length;o<r;o++)t=e[o],l.push(new a.Member.Booking(t));return l}(),r.resolve(e)},function(e){return r.reject(e)}))}}(this),function(e){return r.reject(e)}):r.reject("member does not have bookings"),r.promise},cancel:function(t,o){var r;return r=e.defer(),o.$del("self").then(function(){return function(e){return o.deleted=!0,e=new a.Member.Booking(e),a.Member.Member.$refresh(t).then(function(e){return e=e},function(){}),r.resolve(e)}}(this),function(){return function(e){return r.reject(e)}}(this)),r.promise},update:function(o){var r;return r=e.defer(),o.$put("self",{},o).then(function(){return function(e){var o;return o=new a.Member.Booking(e),t.checkItems(o),r.resolve(o)}}(this),function(){return function(e){return _.each(o,function(e,t,o){if("data"!==t&&"self"!==t)return o[t]=o.data[t]}),r.reject(e,new a.Member.Booking(o))}}(this)),r.promise},flush:function(e,t){if(e.$has("bookings"))return e.$flush("bookings",t)}}}])}.call(this),function(){angular.module("BBMember.Services").factory("MemberLoginService",["$q","$rootScope","$sessionStorage","halClient","BBModel",function(e,t,o,r,a){return{login:function(l,n){var m,i;return m=e.defer(),i=t.bb.api_url+"/api/v1/login",null!=n.company_id&&(i=i+"/member/"+n.company_id),r.$post(i,n,l).then(function(e){return e.$has("member")?e.$get("member").then(function(e){var t;return e=new a.Member.Member(e),t=e._data.getOption("auth_token"),o.setItem("login",e.$toStore()),o.setItem("auth_token",t),m.resolve(e)}):e.$has("members")?m.resolve(e):m.reject("No member account for login")},function(){return function(e){var t;return 400===e.status?(t=r.$parse(e.data),t.$has("members")?m.resolve(t):m.reject(e)):m.reject(e)}}(this)),m.promise}}}])}.call(this),function(){angular.module("BBMember.Services").factory("MemberService",["$q","halClient","$rootScope","BBModel",function(e,t,o,r){return{refresh:function(t){var o;return o=e.defer(),t.$flush("self"),t.$get("self").then(function(){return function(e){return e=new r.Member.Member(e),o.resolve(e)}}(this),function(){return function(e){return o.reject(e)}}(this)),o.promise},current:function(){var t,r;return r=e.defer(),t=function(){return r.resolve(o.member)},setTimeout(t,200),r.promise},updateMember:function(t,o){var a;return a=e.defer(),t.$put("self",{},o).then(function(){return function(e){return e=new r.Member.Member(e),a.resolve(e)}}(this),function(){return function(e){return a.reject(e)}}(this)),a.promise},sendWelcomeEmail:function(t,o){var a;return a=e.defer(),t.$post("send_welcome_email",o).then(function(){return function(e){return e=new r.Member.Member(e),a.resolve(e)}}(this),function(){return function(e){return a.reject(e)}}(this)),a.promise}}}])}.call(this),function(){angular.module("BBMember.Services").factory("MemberPrePaidBookingService",["$q","BBModel",function(e,t){return{query:function(o,r){var a;return a=e.defer(),r||(r={}),r.no_cache=!0,o.$has("pre_paid_bookings")?o.$get("pre_paid_bookings",r).then(function(){return function(e){var o;return angular.isArray(e)?(e=function(){var r,a,l;for(l=[],r=0,a=e.length;r<a;r++)o=e[r],l.push(new t.PrePaidBooking(o));return l}(),a.resolve(e)):(r.no_cache=!1,e.$get("pre_paid_bookings",r).then(function(e){return e=function(){var r,a,l;for(l=[],r=0,a=e.length;r<a;r++)o=e[r],l.push(new t.PrePaidBooking(o));return l}(),a.resolve(e)}))}}(this),function(){return function(e){return a.reject(e)}}(this)):a.reject("member does not have pre paid bookings"),a.promise}}}])}.call(this),function(){angular.module("BBMember.Services").factory("MemberPurchaseService",["$q","$rootScope","BBModel",function(e,t,o){return{query:function(t,r){var a;return r||(r={}),r.no_cache=!0,a=e.defer(),t.$has("purchase_totals")?t.$get("purchase_totals",r).then(function(){return function(e){return r.no_cache=!1,e.$get("purchase_totals",r).then(function(e){var t;return e=function(){var r,a,l;for(l=[],r=0,a=e.length;r<a;r++)t=e[r],l.push(new o.PurchaseTotal(t));return l}(),a.resolve(e)},function(e){return 404===e.status?a.resolve([]):a.reject(e)})}}(this),function(e){return 404===e.status?a.resolve([]):a.reject(e)}):a.reject("member does not have any purchases"),a.promise}}}])}.call(this),function(){angular.module("BBMember.Services").factory("BB.Service.payment_item",["$q","BBModel","UnwrapService",function(e,t,o){return{unwrap:function(e){return o.unwrapResource(t.Member.PaymentItem,e)}}}])}.call(this),function(){angular.module("BBMember.Services").factory("WalletService",["$q","BBModel",function(e,t){return{getWalletForMember:function(o,r){var a;return r||(r={}),r.no_cache=!0,a=e.defer(),o.$has("wallet")?o.$get("wallet",r).then(function(e){return e=new t.Member.Wallet(e),a.resolve(e)},function(e){return a.reject(e)}):a.reject("Wallets are not turned on."),a.promise},getWalletLogs:function(o){var r,a;return a={no_cache:!0},r=e.defer(),o.$has("logs")?o.$get("logs",a).then(function(e){return e.$get("logs").then(function(e){var o;return e=function(){var r,a,l;for(l=[],r=0,a=e.length;r<a;r++)o=e[r],l.push(new t.Member.WalletLog(o));return l}(),r.resolve(e)})},function(){return function(e){return r.reject(e)}}(this)):r.reject("No wallet transactions found"),r.promise},getWalletPurchaseBandsForWallet:function(o){var r;return r=e.defer(),o.$has("purchase_bands")?o.$get("purchase_bands",{}).then(function(e){return e.$get("purchase_bands").then(function(e){var o;return e=function(){var r,a,l;for(l=[],r=0,a=e.length;r<a;r++)o=e[r],l.push(new t.Member.WalletPurchaseBand(o));return l}(),r.resolve(e)})},function(e){return r.reject(e)}):r.reject("No Purchase Bands"),r.promise},updateWalletForMember:function(o,r){var a;return a=e.defer(),o.$has("wallet")?o.$put("wallet",{},r).then(function(e){return e=new t.Member.Wallet(e),a.resolve(e)},function(e){return a.reject(e)}):a.reject("Wallets are not turned on."),a.promise},createWalletForMember:function(o){var r,a;return r=e.defer(),a={},o.$has("wallet")?o.$post("wallet",{},a).then(function(e){return e=new t.Member.Wallet(e),r.resolve(e)},function(e){return r.reject(e)}):r.reject("Wallets are not turned on."),r.promise}}}])}.call(this),function(){'use strict';var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function r(){this.constructor=e}for(var a in t)o.call(t,a)&&(e[a]=t[a]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},o={}.hasOwnProperty;angular.module("BB.Models").factory("Member.BookingModel",["$q","$window","$bbug","MemberBookingService","BBModel","BaseModel",function(o,r,a,l,n,m){var i;return i=function(a){function m(t){this.$getMember=e(this.$getMember,this),m.__super__.constructor.call(this,t),this.datetime=moment.parseZone(this.datetime),this.time_zone&&this.datetime.tz(this.time_zone),this.end_datetime=moment.parseZone(this.end_datetime),this.time_zone&&this.end_datetime.tz(this.time_zone),this.min_cancellation_time=moment(this.min_cancellation_time),this.min_cancellation_hours=this.datetime.diff(this.min_cancellation_time,"hours")}return t(m,a),m.prototype.icalLink=function(){return this._data.$href("ical")},m.prototype.webcalLink=function(){return this._data.$href("ical")},m.prototype.gcalLink=function(){return this._data.$href("gcal")},m.prototype.getGroup=function(){return this.group?this.group:this._data.$has("event_groups")?this._data.$get("event_groups").then(function(e){return function(t){return e.group=t,e.group}}(this)):void 0},m.prototype.getColour=function(){return this.getGroup()?this.getGroup().colour:"#FFFFFF"},m.prototype.getCompany=function(){return this.company?this.company:this.$has("company")?this._data.$get("company").then(function(e){return function(t){return e.company=new n.Company(t),e.company}}(this)):void 0},m.prototype.getAnswers=function(){var e;return e=o.defer(),this.answers&&e.resolve(this.answers),this._data.$has("answers")?this._data.$get("answers").then(function(t){return function(o){var r;return t.answers=function(){var e,t,a;for(a=[],e=0,t=o.length;e<t;e++)r=o[e],a.push(new n.Answer(r));return a}(),e.resolve(t.answers)}}(this)):e.resolve([]),e.promise},m.prototype.printed_price=function(){return 0==parseFloat(this.price)%1?"\xA3"+this.price:r.sprintf("\xA3%.2f",parseFloat(this.price))},m.prototype.$getMember=function(){var e;return e=o.defer(),this.member&&e.resolve(this.member),this._data.$has("member")&&this._data.$get("member").then(function(t){return function(o){return t.member=new n.Member.Member(o),e.resolve(t.member)}}(this)),e.promise},m.prototype.canCancel=function(){return moment(this.min_cancellation_time).isAfter(moment())},m.prototype.canMove=function(){return this.canCancel()},m.prototype.$update=function(){return l.update(this)},m.$query=function(e,t){return l.query(e,t)},m.$cancel=function(e,t){return l.cancel(e,t)},m.$update=function(e){return l.update(e)},m.$flush=function(e,t){return l.flush(e,t)},m}(m)}])}.call(this),function(){var e=function(e,o){function r(){this.constructor=e}for(var a in o)t.call(o,a)&&(e[a]=o[a]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e},t={}.hasOwnProperty;angular.module("BB.Models").factory("Member.MemberModel",["$q","MemberService","BBModel","BaseModel","ClientModel",function(t,o,r,a,l){var n;return n=function(t){function a(){return a.__super__.constructor.apply(this,arguments)}return e(a,t),a.$refresh=function(e){return o.refresh(e)},a.$current=function(){return o.current()},a.$updateMember=function(e,t){return o.updateMember(e,t)},a.$sendWelcomeEmail=function(e,t){return o.sendWelcomeEmail(e,t)},a.prototype.getBookings=function(e){return r.Member.Booking.$query(this,e)},a}(l)}])}.call(this),function(){var e=function(e,o){function r(){this.constructor=e}for(var a in o)t.call(o,a)&&(e[a]=o[a]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e},t={}.hasOwnProperty;angular.module("BB.Models").factory("Member.PaymentItemModel",["BBModel","BaseModel",function(t,o){var r;return r=function(t){function o(e){o.__super__.constructor.call(this,e)}return e(o,t),o}(o)}])}.call(this),function(){'use strict';var e=function(e,o){function r(){this.constructor=e}for(var a in o)t.call(o,a)&&(e[a]=o[a]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e},t={}.hasOwnProperty;angular.module("BB.Models").factory("Member.PrePaidBookingModel",["BaseModel",function(t){var o;return o=function(t){function o(e){o.__super__.constructor.call(this,e)}return e(o,t),o}(t)}])}.call(this),function(){var e=function(e,o){function r(){this.constructor=e}for(var a in o)t.call(o,a)&&(e[a]=o[a]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e},t={}.hasOwnProperty;angular.module("BB.Models").factory("Member.PurchaseModel",["$q","MemberPurchaseService","BBModel","BaseModel",function(t,o,r,a){var l;return l=function(a){function l(e){l.__super__.constructor.call(this,e),this.created_at=moment.parseZone(this.created_at),this.time_zone&&this.created_at.tz(this.time_zone)}return e(l,a),l.prototype.getItems=function(){var e;return e=t.defer(),this._data.$get("purchase_items").then(function(t){var o;return this.items=function(){var e,a,l;for(l=[],e=0,a=t.length;e<a;e++)o=t[e],l.push(new r.Member.PurchaseItem(o));return l}(),e.resolve(this.items)}),e.promise},l.$query=function(e,t){return o.query(e,t)},l}(a)}])}.call(this),function(){var e=function(e,o){function r(){this.constructor=e}for(var a in o)t.call(o,a)&&(e[a]=o[a]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e},t={}.hasOwnProperty;angular.module("BB.Models").factory("Member.PurchaseItemModel",["BBModel","BaseModel",function(t,o){var r;return r=function(t){function o(e){o.__super__.constructor.call(this,e)}return e(o,t),o}(o)}])}.call(this),function(){var e=function(e,o){function r(){this.constructor=e}for(var a in o)t.call(o,a)&&(e[a]=o[a]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e},t={}.hasOwnProperty;angular.module("BB.Models").factory("Member.WalletModel",["WalletService","BBModel","BaseModel",function(t,o,r){var a;return a=function(o){function r(e){r.__super__.constructor.call(this,e)}return e(r,o),r.$getWalletForMember=function(e,o){return t.getWalletForMember(e,o)},r.$getWalletLogs=function(e){return t.getWalletLogs(e)},r.$getWalletPurchaseBandsForWallet=function(e){return t.getWalletPurchaseBandsForWallet(e)},r.$updateWalletForMember=function(e,o){return t.updateWalletForMember(e,o)},r.$createWalletForMember=function(e){return t.createWalletForMember(e)},r}(r)}])}.call(this),function(){var e=function(e,o){function r(){this.constructor=e}for(var a in o)t.call(o,a)&&(e[a]=o[a]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e},t={}.hasOwnProperty;angular.module("BB.Models").factory("Member.WalletLogModel",["$q","BBModel","BaseModel",function(t,o,r){var a;return a=function(t){function o(e){o.__super__.constructor.call(this,e),this.created_at=moment(this.created_at),this.payment_amount=100*parseFloat(this.amount),this.new_wallet_amount=100*parseFloat(this.new_wallet_amount)}return e(o,t),o}(r)}])}.call(this),function(){var e=function(e,o){function r(){this.constructor=e}for(var a in o)t.call(o,a)&&(e[a]=o[a]);return r.prototype=o.prototype,e.prototype=new r,e.__super__=o.prototype,e},t={}.hasOwnProperty;angular.module("BB.Models").factory("Member.WalletPurchaseBandModel",["BBModel","BaseModel",function(t,o){var r;return r=function(t){function o(e){o.__super__.constructor.call(this,e)}return e(o,t),o}(o)}])}.call(this);